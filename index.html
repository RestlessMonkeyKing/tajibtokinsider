<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TikTok Clone</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    header { background: #ff0050; color: white; padding: 20px; text-align: center; font-size: 24px; }
    main { padding: 20px; max-width: 800px; margin: auto; }

    #feed video { width: 100%; margin-bottom: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }

    #uploadSection {
      background: white; padding: 20px; border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 40px;
    }

    button {
      background: #ff0050; color: white; border: none; padding: 10px 20px;
      border-radius: 8px; cursor: pointer; font-size: 16px;
    }
    button:hover { background: #e60047; }

    #progressContainer {
      width: 100%; height: 20px; background: #ddd;
      border-radius: 10px; margin-top: 10px; overflow: hidden;
      display: none;
    }
    #progressBar {
      height: 100%; width: 0%; background: #ff0050;
      transition: width 0.1s linear;
    }
    #progressText { margin-top: 5px; font-weight: bold; }
  </style>
</head>
<body>

<header>TikTok Clone</header>

<main>
  <div id="uploadSection">
    <h2>Upload a Video</h2>
    <input type="file" id="videoInput" accept="video/*"><br><br>
    <button onclick="uploadVideo()">Upload</button>

    <div id="progressContainer">
      <div id="progressBar"></div>
    </div>
    <div id="progressText"></div>

    <p id="status"></p>
  </div>

  <h2>Video Feed</h2>
  <div id="feed"></div>
</main>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabaseUrl = "https://xqecfotbhbccrlamioft.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhxZWNmb3RiaGJjY3JsYW1pb2Z0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMzAzNDksImV4cCI6MjA3OTgwNjM0OX0.aoSZSHK91Ota15IcExrfXZqN0FOQ8cXGWgujy9ECZOg";
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  async function uploadVideo() {
    const file = document.getElementById("videoInput").files[0];
    if (!file) return alert("Please choose a video first!");

    const progressContainer = document.getElementById("progressContainer");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");

    progressContainer.style.display = "block";
    progressBar.style.width = "0%";
    progressText.textContent = "0%";

    const fileName = `${Date.now()}-${file.name}`;
    
    // Manual upload using fetch so we get progress
    const url = `${supabaseUrl}/storage/v1/object/videos/${fileName}`;
    
    const uploadReq = new XMLHttpRequest();
    uploadReq.open("POST", url);
    uploadReq.setRequestHeader("apikey", supabaseKey);
    uploadReq.setRequestHeader("Authorization", `Bearer ${supabaseKey}`);
    uploadReq.setRequestHeader("x-upsert", "false");

    uploadReq.upload.onprogress = function(e) {
      if (e.lengthComputable) {
        const percent = Math.round((e.loaded / e.total) * 100);
        progressBar.style.width = percent + "%";
        progressText.textContent = percent + "%";
      }
    };

    uploadReq.onload = async function() {
      if (uploadReq.status >= 200 && uploadReq.status < 300) {
        progressBar.style.background = "#00c851";  // green when done
        progressText.textContent = "Upload complete! Finalizing...";

        const publicUrl = `${supabaseUrl}/storage/v1/object/public/videos/${fileName}`;

        await supabase.from("videos").insert({
          filename: file.name,
          path: fileName,
          url: publicUrl,
          created_at: new Date()
        });

        document.getElementById("status").textContent = "Saved!";
        loadFeed();
      } else {
        document.getElementById("status").textContent = "Upload error";
      }
    };

    uploadReq.send(file);
  }

  async function loadFeed() {
    const feedDiv = document.getElementById("feed");
    feedDiv.innerHTML = "Loading...";

    const { data, error } = await supabase
      .from("videos")
      .select("*")
      .order("created_at", { ascending: false });

    feedDiv.innerHTML = "";

    if (data) {
      data.forEach(post => {
        const video = document.createElement("video");
        video.src = post.url;
        video.controls = true;
        video.style.display = "block";
        feedDiv.appendChild(video);
      });
    }
  }

  loadFeed();
</script>

</body>
</html>
