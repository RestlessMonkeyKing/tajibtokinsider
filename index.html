<!DOCTYPE html>
<html>
<head>
  <title>Video Upload with ImageKit + Firebase</title>
  <script type="module">

    /* ------------------------------- FIREBASE ------------------------------- */

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { 
      getAuth, 
      GoogleAuthProvider, 
      signInWithPopup 
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

    import {
      getFirestore,
      doc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD1LWvjO4n_e-4X0z37X4VTWNVcwHW88bU",
      authDomain: "ga-w-6184.firebaseapp.com",
      projectId: "ga-w-6184",
      storageBucket: "ga-w-6184.firebasestorage.app",
      messagingSenderId: "356344033975",
      appId: "1:356344033975:web:bfd6692cedfbb8133ed332"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);


    /* ----------------------------- GOOGLE LOGIN ----------------------------- */

    async function loginGoogle() {
      const provider = new GoogleAuthProvider();
      try {
        const result = await signInWithPopup(auth, provider);
        document.getElementById("status").innerText = 
          "Signed in as: " + result.user.email;
      } catch (err) {
        alert("Login error: " + err.message);
      }
    }


    /* ------------------------------ IMAGEKIT VIDEO UPLOAD ------------------------------ */
    
    const IMAGEKIT_PUBLIC_KEY = "public_xR5aWKlHrWkZKKxi1bhQqV/uZh0=";
    const IMAGEKIT_ENDPOINT   = "https://ik.imagekit.io/restlessmonkeyking";
    const UPLOAD_FOLDER       = "/tajibs";

    async function uploadVideoToImageKit(file) {
      const formData = new FormData();
      formData.append("file", file);
      formData.append("publicKey", IMAGEKIT_PUBLIC_KEY);
      formData.append("fileName", file.name);
      formData.append("folder", UPLOAD_FOLDER);
      formData.append("useUniqueFileName", "true");
      formData.append("overwriteFile", "false");

      const uploadURL = "https://upload.imagekit.io/api/v1/files/upload";

      const res = await fetch(uploadURL, {
        method: "POST",
        body: formData
      });

      return await res.json();
    }


    /* ------------------------------ UPLOAD + SAVE ------------------------------ */

    async function handleUpload() {
      const fileInput = document.getElementById("videoInput");
      const file = fileInput.files[0];
      if (!file) return alert("Choose a video first.");
      if (!auth.currentUser) return alert("Login with Google first.");

      // Video file types allowed
      const allowedVideoTypes = ["video/mp4", "video/mov", "video/webm"];
      if (!allowedVideoTypes.includes(file.type)) {
        return alert("Please upload MP4, MOV, or WEBM only.");
      }

      document.getElementById("status").innerText = "Uploading video…";

      // Upload to ImageKit
      const ik = await uploadVideoToImageKit(file);

      if (!ik.url) {
        return alert("ImageKit upload failed.");
      }

      // Save URL to Firestore
      await setDoc(
        doc(db, "videos", auth.currentUser.uid + "_" + Date.now()),
        {
          user: auth.currentUser.email,
          videoURL: ik.url,
          uploaded: new Date()
        }
      );

      document.getElementById("status").innerText = 
        "Uploaded video successfully!\nVideo URL:\n" + ik.url;
    }

    window.loginGoogle = loginGoogle;
    window.handleUpload = handleUpload;

  </script>
</head>

<body style="font-family: Arial; padding: 20px;">

  <h2>Video Upload → ImageKit → Firebase</h2>

  <button onclick="loginGoogle()" style="padding:10px; background:red; color:white;">
    Sign in with Google
  </button>

  <br><br>

  <input type="file" id="videoInput" accept="video/*">
  <br><br>

  <button onclick="handleUpload()" style="padding:10px;">
    Upload Video
  </button>

  <p id="status" style="white-space: pre-wrap;"></p>

</body>
</html>
