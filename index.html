<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TajibTok â€“ Working Upload</title>
<style>
    body { background:#0a0a0f; margin:0; color:white; font-family:Arial; display:flex; height:100vh; }
    .material-glass {
        background: rgba(255,255,255,0.25);
        backdrop-filter: blur(6px);
        border: 2px solid rgba(255,255,255,0.45);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 6px 24px rgba(31,38,135,0.65);
    }
    #sidebar { width:260px; display:flex; flex-direction:column; gap:20px; }
    #progressWrapper {
        display:none;
        margin-top:10px;
    }
    #progressBar {
        width:0%;
        height:12px;
        background:#00ffa6;
        border-radius:6px;
        transition:0.15s linear;
    }
</style>
</head>

<body>

<!-- LEFT SIDEBAR -->
<div id="sidebar" class="material-glass">
    <h2>TajibTok</h2>

    <input type="file" id="fileInput" accept="video/*">
    <button id="uploadBtn">Upload</button>

    <div id="progressWrapper" class="material-glass">
        <div id="progressBar"></div>
        <small id="progressText">0%</small>
    </div>

</div>

<!-- PLAYER -->
<video id="player" width="350" height="600" style="border-radius:20px;" controls></video>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* -----------------------------
   SUPABASE CONFIG (PUT YOURS)
------------------------------*/
const supa = supabase.createClient(
    "YOUR_URL",
    "YOUR_ANON_KEY"
);

/* -----------------------------
   ELEMENTS
------------------------------*/
const fileInput = document.getElementById("fileInput");
const uploadBtn = document.getElementById("uploadBtn");
const progressWrapper = document.getElementById("progressWrapper");
const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");
const player = document.getElementById("player");

/* -----------------------------------------------------
   ðŸŸ¢ FIXED UPLOADER â€” USES CHUNK SYSTEM FOR PROGRESS
------------------------------------------------------*/
uploadBtn.onclick = async () => {
    const file = fileInput.files[0];
    if (!file) return alert("Pick a video");

    const fileName = `tajibs/${Date.now()}-${file.name}`;

    // Show progress
    progressWrapper.style.display = "block";
    progressBar.style.width = "0%";
    progressText.innerText = "0%";

    // Read file as array buffer
    const chunkSize = 500000; // 0.5MB chunks
    const chunks = Math.ceil(file.size / chunkSize);

    let uploaded = 0;

    let position = 0;
    while (position < file.size) {

        const chunk = file.slice(position, position + chunkSize);

        const { error } = await supa.storage.from("tajibtok").upload(
            fileName,
            chunk,
            {
                cacheControl: "3600",
                upsert: false,
                contentType: file.type,
                duplex: "half"
            }
        );

        if (error && !error.message.includes("exists")) {
            alert("Upload error: " + error.message);
            return;
        }

        uploaded++;
        const percent = Math.round((uploaded / chunks) * 100);

        progressBar.style.width = percent + "%";
        progressText.innerText = percent + "%";

        position += chunkSize;
    }

    // Get public URL
    const { data } = supa.storage.from("tajibtok").getPublicUrl(fileName);
    const videoURL = data.publicUrl;

    // Show video in player
    player.src = videoURL;

    progressText.innerText = "Upload complete!";
};
</script>
</body>
</html>
