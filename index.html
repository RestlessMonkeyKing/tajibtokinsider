<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TajibTok</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary: #ff2d55;
            --primary-dark: #e01e4c;
            --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.3);
            --text: white;
            --shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .material-glass {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        /* Login Page */
        #login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 20px;
            animation: fadeIn 0.8s ease;
        }

        .login-container {
            width: 100%;
            max-width: 420px;
            text-align: center;
        }

        .logo {
            font-size: 3.5rem;
            margin-bottom: 16px;
            font-weight: 700;
            background: linear-gradient(45deg, #fff, #e0e0e0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .tagline {
            font-size: 1.1rem;
            margin-bottom: 32px;
            opacity: 0.9;
            font-weight: 400;
        }

        .google-btn {
            width: 100%;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            background: white;
            color: #333;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .google-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .google-icon {
            width: 20px;
            height: 20px;
        }

        /* Main App */
        #main-app {
            display: none;
            height: 100vh;
            padding: 16px;
            animation: fadeIn 0.6s ease;
        }

        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr 280px;
            gap: 20px;
            height: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }

        .avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            margin-right: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-details {
            flex: 1;
        }

        .username {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .user-status {
            font-size: 0.85rem;
            opacity: 0.7;
            margin-top: 4px;
        }

        /* Navigation */
        .nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border: none;
            border-radius: 12px;
            background: transparent;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 1rem;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-btn.active {
            background: rgba(255, 255, 255, 0.15);
            font-weight: 600;
        }

        .nav-btn i {
            font-size: 1.2rem;
            width: 24px;
        }

        .search-input {
            width: 100%;
            padding: 14px 16px;
            margin: 20px 0;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            background: rgba(255, 255, 255, 0.15);
            outline: none;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .logout-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            margin-top: auto;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 1rem;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Video Feed */
        .video-feed {
            height: 100%;
            position: relative;
            overflow: hidden;
            border-radius: 20px;
        }

        .video-container {
            height: 100%;
            position: relative;
        }

        .video-item {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 24px;
            border-radius: 20px;
            transition: transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.5s ease;
            opacity: 0;
        }

        .video-item.active {
            opacity: 1;
        }

        .video-player-container {
            width: 100%;
            height: 100%;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            background: #000;
        }

        .video-player {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-info-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 24px;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            border-radius: 0 0 16px 16px;
            animation: slideUp 0.5s ease 0.3s both;
        }

        .video-caption {
            font-size: 1.4rem;
            margin-bottom: 8px;
            font-weight: 700;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.7);
        }

        .video-description {
            font-size: 1rem;
            opacity: 0.9;
            line-height: 1.5;
            text-shadow: 0 1px 4px rgba(0, 0, 0, 0.7);
        }

        .video-stats {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 12px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding-bottom: 40px;
            gap: 28px;
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: translateY(-4px);
        }

        .action-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.6rem;
            margin-bottom: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .action-btn.liked .action-icon {
            background: rgba(255, 45, 85, 0.4);
            border-color: rgba(255, 45, 85, 0.6);
        }

        .action-count {
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* Navigation Arrows */
        .nav-arrows {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 20px;
        }

        .nav-arrow {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.4rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-arrow:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.1);
        }

        /* Create Page */
        #create-page {
            display: none;
            padding: 20px;
            overflow-y: auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .upload-btn {
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            background: var(--primary);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }

        .upload-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .my-videos {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
        }

        .video-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .video-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 0.12);
        }

        .video-thumbnail {
            width: 100%;
            height: 160px;
            object-fit: cover;
        }

        .video-card-info {
            padding: 20px;
        }

        .video-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .video-card-desc {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .video-card-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            opacity: 0.7;
            margin-bottom: 16px;
        }

        .video-card-actions {
            display: flex;
            gap: 10px;
        }

        .edit-btn, .delete-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .edit-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .edit-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .delete-btn {
            background: rgba(255, 71, 87, 0.2);
            color: rgba(255, 255, 255, 0.9);
        }

        .delete-btn:hover {
            background: rgba(255, 71, 87, 0.3);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            width: 90%;
            max-width: 500px;
            padding: 30px;
            animation: modalSlideIn 0.4s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            transform: rotate(90deg);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            background: rgba(255, 255, 255, 0.15);
            outline: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .upload-status {
            text-align: center;
            margin: 10px 0;
            font-weight: 500;
        }

        /* Share Modal */
        .users-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .user-item {
            display: flex;
            align-items: center;
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.08);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-item:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .user-item.selected {
            background: rgba(255, 45, 85, 0.2);
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            margin-right: 14px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .user-email {
            font-size: 0.85rem;
            opacity: 0.7;
        }

        /* Comments Modal */
        .comments-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .comment-item {
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.08);
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .comment-author {
            font-weight: 500;
        }

        .comment-time {
            opacity: 0.7;
        }

        .add-comment {
            display: flex;
            margin-top: 20px;
        }

        .comment-input {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px 0 0 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }

        .comment-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
        }

        .comment-submit {
            padding: 14px 20px;
            border: none;
            border-radius: 0 10px 10px 0;
            background: var(--primary);
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .comment-submit:hover {
            background: var(--primary-dark);
        }

        /* Popup */
        .popup {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 16px 24px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            z-index: 1001;
            display: none;
            animation: slideInRight 0.4s ease;
            font-weight: 500;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
            }

            .sidebar {
                flex-direction: row;
                height: auto;
                margin-bottom: 16px;
                padding: 16px;
            }

            .user-info {
                margin-bottom: 0;
                margin-right: 16px;
            }

            .nav {
                flex-direction: row;
                margin-bottom: 0;
                flex: 1;
                justify-content: center;
            }

            .nav-btn {
                flex: 1;
                justify-content: center;
            }

            .search-input {
                margin: 0 16px;
                width: auto;
                flex: 1;
            }

            .logout-btn {
                margin-top: 0;
            }

            .action-buttons {
                flex-direction: row;
                justify-content: space-around;
                padding: 16px 0;
            }

            .action-icon {
                width: 50px;
                height: 50px;
                font-size: 1.3rem;
            }
            
            .my-videos {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="login-page">
        <div class="login-container material-glass">
            <div class="logo">TajibTok</div>
            <div class="tagline">Share your moments with the world</div>
            <button class="google-btn" id="google-signin">
                <svg class="google-icon" viewBox="0 0 24 24" width="24" height="24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app">
        <div class="app-container">
            <!-- Left Sidebar -->
            <div class="sidebar material-glass">
                <div class="user-info">
                    <div class="avatar" id="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                        <div class="username" id="logged-user">User</div>
                        <div class="user-status">Welcome back!</div>
                    </div>
                </div>
                
                <div class="nav">
                    <button class="nav-btn active" id="feed-tab" onclick="switchTab('feed')">
                        <i class="fas fa-home"></i> Feed
                    </button>
                    <button class="nav-btn" id="create-tab" onclick="switchTab('create')">
                        <i class="fas fa-plus-circle"></i> Create
                    </button>
                </div>
                
                <input type="text" class="search-input" placeholder="Search videos...">
                
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>

            <!-- Center Content -->
            <div class="video-feed" id="feed-page">
                <div class="video-container" id="video-container">
                    <!-- Videos will be dynamically added here -->
                </div>
            </div>

            <!-- Create Page -->
            <div class="material-glass" id="create-page">
                <div class="page-header">
                    <h2 class="page-title">My Videos</h2>
                    <button class="upload-btn" onclick="openUploadModal()">
                        <i class="fas fa-upload"></i> Upload Video
                    </button>
                </div>
                <div class="my-videos" id="my-videos-container">
                    <!-- User's videos will be displayed here -->
                </div>
            </div>

            <!-- Right Sidebar -->
            <div class="sidebar material-glass">
                <div class="action-buttons">
                    <div class="action-btn" id="like-btn" onclick="likeVideo()">
                        <div class="action-icon">‚ù§Ô∏è</div>
                        <div class="action-count" id="like-count">0</div>
                    </div>
                    <div class="action-btn" onclick="openComments()">
                        <div class="action-icon">üí¨</div>
                        <div class="action-count" id="comment-count">0</div>
                    </div>
                    <div class="action-btn" onclick="openShareModal()">
                        <div class="action-icon">‚ÜóÔ∏è</div>
                        <div class="action-count" id="share-count">0</div>
                    </div>
                </div>
                
                <div class="nav-arrows">
                    <div class="nav-arrow" onclick="prevVideo()">
                        <i class="fas fa-chevron-up"></i>
                    </div>
                    <div class="nav-arrow" onclick="nextVideo()">
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal" id="upload-modal">
        <div class="modal-content material-glass">
            <div class="modal-header">
                <h3 class="modal-title">Upload Video</h3>
                <button class="close-btn" onclick="closeUploadModal()">&times;</button>
            </div>
            <input type="file" id="video-file" accept="video/*" style="display: none;">
            <button class="upload-btn" onclick="document.getElementById('video-file').click()" style="width: 100%; margin-bottom: 20px;">
                <i class="fas fa-folder-open"></i> Choose Video
            </button>
            <div id="file-info" style="margin: 10px 0;"></div>
            <div class="form-group">
                <label class="form-label" for="video-title">Title</label>
                <input type="text" id="video-title" class="form-control" placeholder="Enter video title" required>
            </div>
            <div class="form-group">
                <label class="form-label" for="video-description">Description</label>
                <textarea id="video-description" class="form-control" placeholder="Enter video description" rows="3" required></textarea>
            </div>
            <div class="progress-bar">
                <div class="progress" id="upload-progress"></div>
            </div>
            <div class="upload-status" id="upload-status"></div>
            <button class="upload-btn" id="upload-button" onclick="uploadVideo()" disabled style="width: 100%;">
                <i class="fas fa-cloud-upload-alt"></i> Upload
            </button>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal" id="edit-modal">
        <div class="modal-content material-glass">
            <div class="modal-header">
                <h3 class="modal-title">Edit Video</h3>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-title">Title</label>
                <input type="text" id="edit-title" class="form-control" placeholder="Enter video title">
            </div>
            <div class="form-group">
                <label class="form-label" for="edit-description">Description</label>
                <textarea id="edit-description" class="form-control" placeholder="Enter video description" rows="3"></textarea>
            </div>
            <button class="upload-btn" onclick="saveVideoChanges()" style="width: 100%; margin-bottom: 10px;">
                <i class="fas fa-save"></i> Save Changes
            </button>
            <button class="delete-btn" onclick="deleteVideo()" style="width: 100%;">
                <i class="fas fa-trash"></i> Delete Video
            </button>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal" id="share-modal">
        <div class="modal-content material-glass">
            <div class="modal-header">
                <h3 class="modal-title">Share Video</h3>
                <button class="close-btn" onclick="closeShareModal()">&times;</button>
            </div>
            <p>Select users to share with:</p>
            <div class="users-list" id="users-list">
                <!-- Users will be listed here -->
            </div>
            <button class="upload-btn" onclick="shareVideoWithUsers()" style="width: 100%;">
                <i class="fas fa-share"></i> Share
            </button>
        </div>
    </div>

    <!-- Comments Modal -->
    <div class="modal" id="comments-modal">
        <div class="modal-content material-glass">
            <div class="modal-header">
                <h3 class="modal-title">Comments</h3>
                <button class="close-btn" onclick="closeCommentsModal()">&times;</button>
            </div>
            <div class="comments-list" id="comments-list">
                <!-- Comments will be listed here -->
            </div>
            <div class="add-comment">
                <input type="text" class="comment-input" id="comment-input" placeholder="Add a comment...">
                <button class="comment-submit" onclick="addComment()">Post</button>
            </div>
        </div>
    </div>

    <!-- Popup Messages -->
    <div class="popup" id="popup"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD1LWvjO4n_e-4X0z37X4VTWNVcwHW88bU",
            authDomain: "ga-w-6184.firebaseapp.com",
            projectId: "ga-w-6184",
            storageBucket: "ga-w-6184.firebasestorage.app",
            messagingSenderId: "356344033975",
            appId: "1:356344033975:web:bfd6692cedfbb8133ed332"
        };

        // ImageKit Configuration
        const IMAGEKIT_UPLOAD_URL = "https://upload.imagekit.io/api/v1/files/upload";
        const IMAGEKIT_PRIVATE_KEY = "private_BdWBQOhxDNprEqkzJ8sdZmSI3U0=";
        const IMAGEKIT_FOLDER = "/tajibs";

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // App State
        let currentUser = null;
        let currentVideoIndex = 0;
        let videos = [];
        let currentVideoId = null;
        let editingVideoId = null;
        let selectedUsers = [];
        let isSwiping = false;
        let startY = 0;

        // DOM Elements
        const loginPage = document.getElementById('login-page');
        const mainApp = document.getElementById('main-app');
        const loggedUser = document.getElementById('logged-user');
        const userAvatar = document.getElementById('user-avatar');
        const videoContainer = document.getElementById('video-container');
        const uploadModal = document.getElementById('upload-modal');
        const editModal = document.getElementById('edit-modal');
        const shareModal = document.getElementById('share-modal');
        const commentsModal = document.getElementById('comments-modal');
        const popup = document.getElementById('popup');
        const likeCount = document.getElementById('like-count');
        const commentCount = document.getElementById('comment-count');
        const shareCount = document.getElementById('share-count');
        const likeBtn = document.getElementById('like-btn');
        const videoFileInput = document.getElementById('video-file');
        const uploadButton = document.getElementById('upload-button');
        const uploadProgress = document.getElementById('upload-progress');
        const uploadStatus = document.getElementById('upload-status');
        const fileInfo = document.getElementById('file-info');
        const videoTitle = document.getElementById('video-title');
        const videoDescription = document.getElementById('video-description');
        const googleSignInBtn = document.getElementById('google-signin');
        const feedPage = document.getElementById('feed-page');
        const createPage = document.getElementById('create-page');
        const myVideosContainer = document.getElementById('my-videos-container');
        const usersList = document.getElementById('users-list');
        const commentsList = document.getElementById('comments-list');
        const commentInput = document.getElementById('comment-input');

        // Initialize the app
        function init() {
            setupEventListeners();
            
            // Check if user is already signed in
            auth.onAuthStateChanged(user => {
                if (user) {
                    handleUserSignIn(user);
                } else {
                    loginPage.style.display = 'flex';
                    mainApp.style.display = 'none';
                }
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            googleSignInBtn.addEventListener('click', signInWithGoogle);
            
            videoFileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    const file = this.files[0];
                    fileInfo.innerHTML = `Selected: ${file.name} (${formatFileSize(file.size)})`;
                    uploadButton.disabled = false;
                } else {
                    fileInfo.innerHTML = '';
                    uploadButton.disabled = true;
                }
            });

            // Improved swipe detection with better handling
            videoContainer.addEventListener('touchstart', function(e) {
                isSwiping = true;
                startY = e.touches[0].clientY;
            });
            
            videoContainer.addEventListener('touchmove', function(e) {
                if (!isSwiping) return;
                
                const currentY = e.touches[0].clientY;
                const diff = startY - currentY;
                
                // Prevent default to avoid page scrolling
                if (Math.abs(diff) > 10) {
                    e.preventDefault();
                }
            });
            
            videoContainer.addEventListener('touchend', function(e) {
                if (!isSwiping) return;
                
                const endY = e.changedTouches[0].clientY;
                const diff = startY - endY;
                
                if (Math.abs(diff) > 50) { // Minimum swipe distance
                    if (diff > 0) {
                        nextVideo();
                    } else {
                        prevVideo();
                    }
                }
                
                isSwiping = false;
            });
            
            // Mouse wheel navigation for desktop
            videoContainer.addEventListener('wheel', function(e) {
                e.preventDefault();
                if (e.deltaY > 0) {
                    nextVideo();
                } else {
                    prevVideo();
                }
            });
            
            // Keyboard navigation
            document.addEventListener('keydown', function(e) {
                if (feedPage.style.display === 'block') {
                    if (e.key === 'ArrowDown' || e.key === ' ') {
                        e.preventDefault();
                        nextVideo();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        prevVideo();
                    }
                }
            });
        }

        // Switch between tabs
        function switchTab(tabName) {
            document.getElementById('feed-tab').classList.toggle('active', tabName === 'feed');
            document.getElementById('create-tab').classList.toggle('active', tabName === 'create');
            
            feedPage.style.display = tabName === 'feed' ? 'block' : 'none';
            createPage.style.display = tabName === 'create' ? 'block' : 'none';
            
            if (tabName === 'create') {
                loadUserVideos();
            }
        }

        // Google Sign-In function
        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            
            auth.signInWithPopup(provider)
                .then((result) => {
                    handleUserSignIn(result.user);
                })
                .catch((error) => {
                    console.error("Error during sign in:", error);
                    showPopup('Sign in failed. Please try again.', 'error');
                });
        }

        // Handle user sign in
        function handleUserSignIn(user) {
            currentUser = user;
            
            loggedUser.textContent = user.displayName || user.email;
            
            if (user.photoURL) {
                userAvatar.innerHTML = `<img src="${user.photoURL}" alt="Profile">`;
            } else {
                userAvatar.innerHTML = `<i class="fas fa-user"></i>`;
            }
            
            loginPage.style.display = 'none';
            mainApp.style.display = 'block';
            
            loadVideos();
            
            showPopup(`Welcome to TajibTok, ${user.displayName || 'User'}!`, 'success');
        }

        // Logout function
        function logout() {
            auth.signOut()
                .then(() => {
                    showPopup('Signed out successfully', 'success');
                    loginPage.style.display = 'flex';
                    mainApp.style.display = 'none';
                    currentUser = null;
                })
                .catch((error) => {
                    console.error("Error during sign out:", error);
                    showPopup('Sign out failed. Please try again.', 'error');
                });
        }

        // Load videos from Firebase
        function loadVideos() {
            db.collection("tajibs").orderBy("createdAt", "desc")
                .get()
                .then((querySnapshot) => {
                    videos = [];
                    querySnapshot.forEach((doc) => {
                        const videoData = doc.data();
                        videos.push({
                            id: doc.id,
                            url: videoData.videoURL,
                            caption: videoData.caption || "Shared on TajibTok",
                            description: videoData.description || "",
                            likes: videoData.likes || 0,
                            comments: videoData.comments || 0,
                            shares: videoData.shares || 0,
                            userId: videoData.userId,
                            userName: videoData.userName,
                            userPhoto: videoData.userPhoto,
                            likedBy: videoData.likedBy || []
                        });
                    });
                    
                    if (videos.length === 0) {
                        videos = getDemoVideos();
                    }
                    
                    renderVideos();
                })
                .catch((error) => {
                    console.error("Error loading videos:", error);
                    videos = getDemoVideos();
                    renderVideos();
                    showPopup('Using demo videos', 'info');
                });
        }

        // Load user's videos for the Create tab
        function loadUserVideos() {
            if (!currentUser) return;
            
            db.collection("tajibs")
                .where("userId", "==", currentUser.uid)
                .orderBy("createdAt", "desc")
                .get()
                .then((querySnapshot) => {
                    myVideosContainer.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const videoData = doc.data();
                        const videoCard = document.createElement('div');
                        videoCard.className = 'video-card';
                        videoCard.innerHTML = `
                            <img src="https://img.icons8.com/color/96/000000/video.png" class="video-thumbnail" alt="Video Thumbnail">
                            <div class="video-card-info">
                                <div class="video-card-title">${videoData.caption || 'My Video'}</div>
                                <div class="video-card-desc">${videoData.description || 'No description'}</div>
                                <div class="video-card-stats">
                                    <span>‚ù§Ô∏è ${videoData.likes || 0}</span>
                                    <span>üí¨ ${videoData.comments || 0}</span>
                                    <span>‚ÜóÔ∏è ${videoData.shares || 0}</span>
                                </div>
                                <div class="video-card-actions">
                                    <button class="edit-btn" onclick="openEditModal('${doc.id}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="delete-btn" onclick="deleteVideo('${doc.id}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        `;
                        myVideosContainer.appendChild(videoCard);
                    });
                    
                    if (querySnapshot.empty) {
                        myVideosContainer.innerHTML = '<p>You haven\'t uploaded any videos yet.</p>';
                    }
                })
                .catch((error) => {
                    console.error("Error loading user videos:", error);
                    myVideosContainer.innerHTML = '<p>Error loading your videos.</p>';
                });
        }

        // Get demo videos (fallback)
        function getDemoVideos() {
            return [
                {
                    id: 1,
                    url: "https://assets.mixkit.co/videos/preview/mixkit-tree-with-yellow-flowers-1173-large.mp4",
                    caption: "Beautiful nature scenery",
                    description: "A beautiful view of nature with yellow flowers",
                    likes: 1245,
                    comments: 89,
                    shares: 34,
                    likedBy: []
                },
                {
                    id: 2,
                    url: "https://assets.mixkit.co/videos/preview/mixkit-waves-in-the-water-1164-large.mp4",
                    caption: "Calming ocean waves",
                    description: "Relaxing waves in the ocean",
                    likes: 892,
                    comments: 45,
                    shares: 21,
                    likedBy: []
                },
                {
                    id: 3,
                    url: "https://assets.mixkit.co/videos/preview/mixkit-going-down-a-curved-highway-down-a-mountain-41576-large.mp4",
                    caption: "Mountain road drive",
                    description: "Driving through scenic mountain roads",
                    likes: 1567,
                    comments: 112,
                    shares: 67,
                    likedBy: []
                }
            ];
        }

        // Render videos in the feed
        function renderVideos() {
            videoContainer.innerHTML = '';
            
            videos.forEach((video, index) => {
                const videoItem = document.createElement('div');
                videoItem.className = `video-item ${index === 0 ? 'active' : ''}`;
                
                videoItem.innerHTML = `
                    <div class="video-player-container">
                        <video class="video-player" loop ${index === 0 ? 'autoplay' : ''}>
                            <source src="${video.url}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        <div class="video-info-overlay">
                            <div class="video-caption">${video.caption}</div>
                            <div class="video-description">${video.description}</div>
                            <div class="video-stats">
                                <span>üí¨ ${video.comments}</span>
                                <span>‚ÜóÔ∏è ${video.shares}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                videoContainer.appendChild(videoItem);
                
                if (index === 0) {
                    currentVideoId = video.id;
                    updateActionCounts();
                    checkIfUserLikedVideo();
                }
            });
        }

        // Update action counts for current video
        function updateActionCounts() {
            if (videos.length > 0) {
                const currentVideo = videos[currentVideoIndex];
                likeCount.textContent = currentVideo.likes;
                commentCount.textContent = currentVideo.comments;
                shareCount.textContent = currentVideo.shares;
            }
        }

        // Check if current user has liked the video
        function checkIfUserLikedVideo() {
            if (!currentUser || !currentVideoId) return;
            
            const currentVideo = videos.find(v => v.id === currentVideoId);
            if (currentVideo && currentVideo.likedBy && currentVideo.likedBy.includes(currentUser.uid)) {
                likeBtn.classList.add('liked');
            } else {
                likeBtn.classList.remove('liked');
            }
        }

        // Navigate to next video
        function nextVideo() {
            if (currentVideoIndex < videos.length - 1) {
                const currentVideoElement = document.querySelectorAll('.video-item')[currentVideoIndex];
                const nextVideoElement = document.querySelectorAll('.video-item')[currentVideoIndex + 1];
                
                currentVideoElement.classList.remove('active');
                nextVideoElement.classList.add('active');
                
                const currentVideoPlayer = currentVideoElement.querySelector('video');
                if (currentVideoPlayer) {
                    currentVideoPlayer.pause();
                }
                
                const nextVideoPlayer = nextVideoElement.querySelector('video');
                if (nextVideoPlayer) {
                    nextVideoPlayer.play().catch(e => console.log('Autoplay prevented:', e));
                }
                
                currentVideoIndex++;
                currentVideoId = videos[currentVideoIndex].id;
                updateActionCounts();
                checkIfUserLikedVideo();
            }
        }

        // Navigate to previous video
        function prevVideo() {
            if (currentVideoIndex > 0) {
                const currentVideoElement = document.querySelectorAll('.video-item')[currentVideoIndex];
                const prevVideoElement = document.querySelectorAll('.video-item')[currentVideoIndex - 1];
                
                currentVideoElement.classList.remove('active');
                prevVideoElement.classList.add('active');
                
                const currentVideoPlayer = currentVideoElement.querySelector('video');
                if (currentVideoPlayer) {
                    currentVideoPlayer.pause();
                }
                
                const prevVideoPlayer = prevVideoElement.querySelector('video');
                if (prevVideoPlayer) {
                    prevVideoPlayer.play().catch(e => console.log('Autoplay prevented:', e));
                }
                
                currentVideoIndex--;
                currentVideoId = videos[currentVideoIndex].id;
                updateActionCounts();
                checkIfUserLikedVideo();
            }
        }

        // Open upload modal
        function openUploadModal() {
            if (!currentUser) {
                showPopup('Please sign in to upload videos', 'error');
                return;
            }
            uploadModal.style.display = 'flex';
            resetUploadForm();
        }

        // Close upload modal
        function closeUploadModal() {
            uploadModal.style.display = 'none';
            resetUploadForm();
        }

        // Reset upload form
        function resetUploadForm() {
            videoFileInput.value = '';
            fileInfo.innerHTML = '';
            uploadButton.disabled = true;
            uploadProgress.style.width = '0%';
            uploadStatus.innerHTML = '';
            videoTitle.value = '';
            videoDescription.value = '';
        }

        // Upload video to ImageKit
        async function uploadToImageKit(file, onProgress) {
            return new Promise((resolve, reject) => {
                const form = new FormData();
                form.append("file", file);
                form.append("fileName", Date.now() + "-" + file.name);
                form.append("folder", IMAGEKIT_FOLDER);

                const xhr = new XMLHttpRequest();
                xhr.open("POST", IMAGEKIT_UPLOAD_URL, true);
                xhr.setRequestHeader("Authorization", "Basic " + btoa(IMAGEKIT_PRIVATE_KEY + ":"));

                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        onProgress(percent);
                    }
                };

                xhr.onreadystatechange = () => {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            resolve(JSON.parse(xhr.responseText));
                        } else {
                            reject("Upload failed: " + xhr.responseText);
                        }
                    }
                };
                xhr.send(form);
            });
        }

        // Save video URL to Firestore
        async function saveVideoToFirestore(videoData) {
            return db.collection("tajibs").add(videoData);
        }

        // Upload video function
        function uploadVideo() {
            const file = videoFileInput.files[0];
            const title = videoTitle.value.trim();
            const description = videoDescription.value.trim();
            
            if (!file) {
                showPopup('Pick a video!', 'error');
                return;
            }
            
            if (!title) {
                showPopup('Please add a title!', 'error');
                return;
            }
            
            if (!description) {
                showPopup('Please add a description!', 'error');
                return;
            }
            
            uploadButton.disabled = true;
            uploadStatus.innerHTML = 'Uploading...';
            
            uploadToImageKit(file, (progress) => {
                uploadProgress.style.width = `${progress}%`;
            }).then(result => {
                const newVideo = {
                    videoURL: result.url,
                    caption: title,
                    description: description,
                    likes: 0,
                    comments: 0,
                    shares: 0,
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    userPhoto: currentUser.photoURL,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    likedBy: []
                };
                
                return saveVideoToFirestore(newVideo);
            }).then(() => {
                uploadStatus.innerHTML = 'Upload complete!';
                showPopup('Video uploaded successfully!', 'success');
                
                loadVideos();
                loadUserVideos();
                
                setTimeout(() => {
                    closeUploadModal();
                }, 1500);
            }).catch(error => {
                console.error("Upload error:", error);
                uploadStatus.innerHTML = 'Error: Upload failed';
                showPopup('Upload failed. Please try again.', 'error');
                uploadButton.disabled = false;
            });
        }

        // Open edit modal
        function openEditModal(videoId) {
            if (!currentUser) return;
            
            editingVideoId = videoId;
            
            db.collection("tajibs").doc(videoId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const videoData = doc.data();
                        document.getElementById('edit-title').value = videoData.caption || '';
                        document.getElementById('edit-description').value = videoData.description || '';
                        editModal.style.display = 'flex';
                    }
                })
                .catch((error) => {
                    console.error("Error loading video data:", error);
                    showPopup('Error loading video data', 'error');
                });
        }

        // Close edit modal
        function closeEditModal() {
            editModal.style.display = 'none';
            editingVideoId = null;
        }

        // Save video changes
        function saveVideoChanges() {
            if (!editingVideoId) return;
            
            const title = document.getElementById('edit-title').value.trim();
            const description = document.getElementById('edit-description').value.trim();
            
            if (!title) {
                showPopup('Please enter a title!', 'error');
                return;
            }
            
            db.collection("tajibs").doc(editingVideoId).update({
                caption: title,
                description: description
            })
            .then(() => {
                showPopup('Video updated successfully!', 'success');
                closeEditModal();
                loadUserVideos();
                loadVideos();
            })
            .catch((error) => {
                console.error("Error updating video:", error);
                showPopup('Error updating video', 'error');
            });
        }

        // Delete video
        function deleteVideo(videoId) {
            if (!videoId) videoId = editingVideoId;
            if (!videoId) return;
            
            if (!confirm('Are you sure you want to delete this video?')) {
                return;
            }
            
            db.collection("tajibs").doc(videoId).delete()
                .then(() => {
                    showPopup('Video deleted successfully!', 'success');
                    closeEditModal();
                    loadUserVideos();
                    loadVideos();
                })
                .catch((error) => {
                    console.error("Error deleting video:", error);
                    showPopup('Error deleting video', 'error');
                });
        }

        // Like video function (with one like per user limit)
        function likeVideo() {
            if (!currentUser || !currentVideoId) {
                showPopup('Please sign in to like videos', 'error');
                return;
            }
            
            const currentVideo = videos.find(v => v.id === currentVideoId);
            if (!currentVideo) return;
            
            // Check if user already liked this video
            if (currentVideo.likedBy && currentVideo.likedBy.includes(currentUser.uid)) {
                showPopup('You already liked this video!', 'info');
                return;
            }
            
            // Update in Firestore
            const updatedLikedBy = currentVideo.likedBy ? [...currentVideo.likedBy, currentUser.uid] : [currentUser.uid];
            
            db.collection("tajibs").doc(currentVideoId).update({
                likes: firebase.firestore.FieldValue.increment(1),
                likedBy: updatedLikedBy
            })
            .then(() => {
                // Update local state
                currentVideo.likes++;
                currentVideo.likedBy = updatedLikedBy;
                updateActionCounts();
                likeBtn.classList.add('liked');
                showPopup('Liked! ‚ù§Ô∏è', 'success');
            })
            .catch((error) => {
                console.error("Error liking video:", error);
                showPopup('Error liking video', 'error');
            });
        }

        // Open comments modal
        function openComments() {
            if (!currentUser) {
                showPopup('Please sign in to view comments', 'error');
                return;
            }
            
            if (!currentVideoId) return;
            
            loadComments();
            commentsModal.style.display = 'flex';
        }

        // Close comments modal
        function closeCommentsModal() {
            commentsModal.style.display = 'none';
            commentInput.value = '';
        }

        // Load comments for current video
        function loadComments() {
            if (!currentVideoId) return;
            
            commentsList.innerHTML = '<p>Loading comments...</p>';
            
            db.collection("tajibs").doc(currentVideoId).collection("comments")
                .orderBy("createdAt", "desc")
                .get()
                .then((querySnapshot) => {
                    commentsList.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        commentsList.innerHTML = '<p>No comments yet. Be the first to comment!</p>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const commentData = doc.data();
                        const commentItem = document.createElement('div');
                        commentItem.className = 'comment-item';
                        commentItem.innerHTML = `
                            <div class="comment-header">
                                <span class="comment-author">${commentData.userName || 'Anonymous'}</span>
                                <span class="comment-time">${formatDate(commentData.createdAt?.toDate())}</span>
                            </div>
                            <div>${commentData.text}</div>
                        `;
                        commentsList.appendChild(commentItem);
                    });
                })
                .catch((error) => {
                    console.error("Error loading comments:", error);
                    commentsList.innerHTML = '<p>Error loading comments</p>';
                });
        }

        // Add a comment
        function addComment() {
            if (!currentUser || !currentVideoId) return;
            
            const commentText = commentInput.value.trim();
            if (!commentText) {
                showPopup('Please enter a comment!', 'error');
                return;
            }
            
            // Add comment to Firestore
            db.collection("tajibs").doc(currentVideoId).collection("comments").add({
                text: commentText,
                userId: currentUser.uid,
                userName: currentUser.displayName,
                userPhoto: currentUser.photoURL,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                // Update comment count
                db.collection("tajibs").doc(currentVideoId).update({
                    comments: firebase.firestore.FieldValue.increment(1)
                })
                .then(() => {
                    commentInput.value = '';
                    loadComments();
                    updateActionCounts();
                    showPopup('Comment added!', 'success');
                });
            })
            .catch((error) => {
                console.error("Error adding comment:", error);
                showPopup('Error adding comment', 'error');
            });
        }

        // Open share modal
        function openShareModal() {
            if (!currentUser) {
                showPopup('Please sign in to share videos', 'error');
                return;
            }
            
            if (!currentVideoId) return;
            
            loadUsersForSharing();
            shareModal.style.display = 'flex';
        }

        // Close share modal
        function closeShareModal() {
            shareModal.style.display = 'none';
            selectedUsers = [];
        }

        // Load users for sharing
        function loadUsersForSharing() {
            usersList.innerHTML = '<p>Loading users...</p>';
            selectedUsers = [];
            
            // In a real app, you would fetch actual users from Firestore
            const mockUsers = [
                { id: 'user1', name: 'Alex Johnson', email: 'alex.johnson@example.com', photo: null },
                { id: 'user2', name: 'Maria Garcia', email: 'maria.garcia@example.com', photo: null },
                { id: 'user3', name: 'James Wilson', email: 'james.wilson@example.com', photo: null },
                { id: 'user4', name: 'Sarah Chen', email: 'sarah.chen@example.com', photo: null },
                { id: 'user5', name: 'David Kim', email: 'david.kim@example.com', photo: null }
            ];
            
            usersList.innerHTML = '';
            mockUsers.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.dataset.userId = user.id;
                userItem.innerHTML = `
                    <div class="user-avatar">
                        ${user.photo ? `<img src="${user.photo}" alt="${user.name}">` : '<i class="fas fa-user"></i>'}
                    </div>
                    <div class="user-details">
                        <div class="user-name">${user.name}</div>
                        <div class="user-email">${user.email}</div>
                    </div>
                `;
                userItem.addEventListener('click', () => {
                    userItem.classList.toggle('selected');
                    if (userItem.classList.contains('selected')) {
                        selectedUsers.push(user.id);
                    } else {
                        selectedUsers = selectedUsers.filter(id => id !== user.id);
                    }
                });
                usersList.appendChild(userItem);
            });
        }

        // Share video with selected users
        function shareVideoWithUsers() {
            if (selectedUsers.length === 0) {
                showPopup('Please select at least one user to share with', 'error');
                return;
            }
            
            showPopup(`Video shared with ${selectedUsers.length} user(s)!`, 'success');
            
            // Update share count
            db.collection("tajibs").doc(currentVideoId).update({
                shares: firebase.firestore.FieldValue.increment(selectedUsers.length)
            })
            .then(() => {
                updateActionCounts();
                closeShareModal();
            })
            .catch((error) => {
                console.error("Error updating share count:", error);
            });
        }

        // Utility functions
        function showPopup(message, type) {
            popup.textContent = message;
            popup.style.display = 'block';
            popup.style.background = type === 'error' ? 'rgba(255, 0, 0, 0.7)' : 
                                    type === 'success' ? 'rgba(0, 200, 0, 0.7)' : 
                                    'rgba(0, 0, 0, 0.7)';
            
            setTimeout(() => {
                popup.style.display = 'none';
            }, 3000);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(date) {
            if (!date) return 'Unknown date';
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
